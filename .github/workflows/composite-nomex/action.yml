name: "matlab-nomex"

runs:

  using: "composite"

  steps:

  - name: Main Tests
    if: ${{ matrix.release >= 'R2024b' }}
    uses: matlab-actions/run-build@v2
    with:
      startup-options: ${{ matrix.startup-options }}
      tasks: test:main


  - name: Main Tests (< R2024b)
    if: ${{ matrix.release >= 'R2022b' && matrix.release < 'R2024b' }}
    uses: matlab-actions/run-build@v2
    with:
      startup-options: ${{ matrix.startup-options }}
      tasks: test_main


  - name: Java Test
    if: ${{ !contains(matrix.startup-options, '-nojvm') && matrix.release >= 'R2024b' }}
    uses: matlab-actions/run-build@v2
    with:
      startup-options: ${{ matrix.startup-options }}
      tasks: test:java test:java_exe


  - name: Java Test (R2023b..R2024a)
    if: ${{ !contains(matrix.startup-options, '-nojvm') && matrix.release >= 'R2023b' && matrix.release < 'R2024b' }}
    uses: matlab-actions/run-build@v2
    with:
      startup-options: ${{ matrix.startup-options }}
      tasks: test_java test_java_exe


  - name: Exe Test (>= R2024b)
    if: ${{ matrix.release >= 'R2024b' }}
    uses: matlab-actions/run-build@v2
    with:
      startup-options: -logfile ${{ matrix.release }}-${{ runner.os }}-test.log
      tasks: test:exe

  - name: Exe Test (legacy)
    if: ${{ matrix.release >= 'R2023b' && matrix.release < 'R2024b' }}
    uses: matlab-actions/run-build@v2
    with:
      startup-options: -logfile ${{ matrix.release }}-${{ runner.os }}-test.log
      tasks: test_exe


# note: "source-folder" adds all subfolders to Matlab path
# https://github.com/matlab-actions/run-tests?tab=readme-ov-file#run-matlab-tests
  - name: Non-buildtool tests (< R2022b)
    if: ${{ matrix.release < 'R2022b' }}
    uses: matlab-actions/run-command@v2
    with:
      command: test_main
      startup-options: -logfile ${{ matrix.release }}-${{ runner.os }}-test.log

  - name: upload logfile
    if: ${{ hashFiles(matrix.release-runner.os-test.log) != '' }}
    uses: actions/upload-artifact@v4
    with:
      name: ${{ matrix.release }}-${{ runner.os }}-test-log
      path: ${{ matrix.release }}-${{ runner.os }}-test.log
      retention-days: 1
